## å•è°ƒæ ˆ + æ•°å­¦

> åŸé¢˜è§£é“¾æ¥åœ¨ [è¿™é‡Œ](https://leetcode.cn/problems/sum-of-subarray-minimums/solution/by-ac_oier-h9cd/)ï¼Œæœ¬æ¬¡å¢åŠ äº†æ›´ä¸ºè¯¦ç»†çš„ç»†èŠ‚è¯´æ˜ã€‚

åŸé—®é¢˜ä¸ºæ±‚æ‰€æœ‰å­æ•°ç»„çš„æœ€å°å€¼ä¹‹å’Œã€‚

ç»Ÿè®¡æ‰€æœ‰å­æ•°ç»„éœ€è¦æšä¸¾å·¦å³ç«¯ç‚¹ï¼Œå¤æ‚åº¦ä¸º $O(n^2)$ï¼Œå¯¹äºæ¯ä¸ªå­æ•°ç»„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡çº¿æ€§æ‰«æçš„æ–¹å¼æ‰¾åˆ°å…¶æœ€å°å€¼ï¼Œå¤æ‚åº¦ä¸º $O(n)$ï¼Œå› æ­¤æœ´ç´ è§£æ³•çš„æ•´ä½“å¤æ‚åº¦ä¸º $O(n^3)$ï¼Œé¢˜ç›®ç»™å®šæ•°æ®èŒƒå›´ä¸º $3 \times 10^4$ï¼Œä¼š `TLE`ã€‚

ç”±äºæˆ‘ä»¬æ˜¯ä»å­æ•°ç»„ä¸­å–æœ€å°å€¼æ¥è¿›è¡Œç´¯åŠ ï¼Œå³å‚ä¸ç­”æ¡ˆæ„æˆçš„æ¯ä¸ªæ•°å¿…ç„¶æŸä¸ªå…·ä½“çš„ $arr[i]$ã€‚

**å› æ­¤æˆ‘ä»¬å¯ä»¥å°†åŸé—®é¢˜è½¬åŒ–ä¸ºã€Œè€ƒè™‘ç»Ÿè®¡æ¯ä¸ª $arr[i]$ å¯¹ç­”æ¡ˆçš„è´¡çŒ®ã€ã€‚**

å¯¹äºæŸä¸€ä¸ª $arr[i]$ è€Œè¨€ï¼Œæˆ‘ä»¬è€ƒè™‘å…¶èƒ½å¤Ÿä½œä¸ºå“ªäº›å­æ•°ç»„çš„æœ€å°å€¼ã€‚

æˆ‘ä»¬å¯ä»¥æƒ³è±¡ä»¥ $arr[i]$ ä¸ºä¸­å¿ƒï¼Œåˆ†åˆ«å¾€ä¸¤ç«¯è¿›è¡Œæ‹“å±•ï¼Œåªè¦æ–°æ‹“å±•çš„è¾¹ç•Œä¸ä¼šæ”¹å˜ã€Œ$arr[i]$ ä¸ºå½“å‰å­æ•°ç»„çš„æœ€å°å€¼ã€çš„æ€§è´¨å³å¯ã€‚

æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ° $arr[i]$ ä½œä¸ºæœ€å°å€¼çš„æœ€è¿œå·¦å³è¾¹ç•Œï¼Œå³æ‰¾åˆ° $arr[i]$ å·¦å³æœ€è¿‘ä¸€ä¸ªæ¯”å…¶å°çš„ä½ç½® `l` å’Œ `r`ã€‚

**åœ¨ç»™å®šåºåˆ—ä¸­ï¼Œæ‰¾åˆ°ä»»æ„ $A[i]$ æœ€è¿‘ä¸€ä¸ªæ¯”å…¶å¤§/å°çš„ä½ç½®ï¼Œå¯ä½¿ç”¨ã€Œå•è°ƒæ ˆã€è¿›è¡Œæ±‚è§£ã€‚**

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¼šè‡ªç„¶æƒ³åˆ°ï¼Œé€šè¿‡å•è°ƒæ ˆçš„æ–¹å¼ï¼Œåˆ†åˆ«é¢„å¤„ç†é™¤ `l` å’Œ `r` æ•°ç»„ï¼š

* `l[i] = loc` å«ä¹‰ä¸ºä¸‹æ ‡ `i` å·¦è¾¹æœ€è¿‘ä¸€ä¸ªæ¯” `arr[i]` å°çš„ä½ç½®æ˜¯ `loc`ï¼ˆè‹¥åœ¨ $arr[i]$ å·¦ä¾§ä¸å­˜åœ¨æ¯”å…¶å°çš„æ•°ï¼Œåˆ™ `loc = -1`ï¼‰
* `r[i] = loc` å«ä¹‰ä¸ºä¸‹æ ‡ `i` å³è¾¹æœ€è¿‘ä¸€ä¸ªæ¯” `arr[i]` å°çš„ä½ç½®æ˜¯ `loc`ï¼ˆè‹¥åœ¨ $arr[i]$ å·¦ä¾§ä¸å­˜åœ¨æ¯”å…¶å°çš„æ•°ï¼Œåˆ™ `loc = n`ï¼‰

å½“æˆ‘ä»¬é¢„å¤„ç†ä¸¤æ•°ç»„åï¼Œé€šè¿‡ç®€å•ã€Œä¹˜æ³•åŸç†ã€å³å¯ç»Ÿè®¡ä»¥ $arr[i]$ ä¸ºæœ€å°å€¼æ—¶ï¼Œå­æ•°ç»„çš„ä¸ªæ•°ï¼š

* åŒ…å« $arr[i]$ çš„å­æ•°ç»„å·¦ç«¯ç‚¹ä¸ªæ•°ä¸º $a = i - l[i]$ ä¸ª
* åŒ…å« $arr[i]$ çš„å­æ•°ç»„å³ç«¯ç‚¹ä¸ªæ•°ä¸º $b = r[i] - i$ ä¸ª

å­æ•°ç»„çš„ä¸ªæ•° $\times$ å­æ•°ç»„æœ€å°å€¼ $arr[i]$ï¼Œå³æ˜¯å½“å‰ $arr[i]$ å¯¹ç­”æ¡ˆçš„è´¡çŒ®ï¼š$a \times b \times arr[i]$ã€‚

**ç»Ÿè®¡æ‰€æœ‰ $arr[i]$ å¯¹ç­”æ¡ˆçš„è´¡çŒ®å³æ˜¯æœ€ç»ˆç­”æ¡ˆï¼Œä½†æˆ‘ä»¬å¿½ç•¥äº†ã€Œå½“  `arr` å­˜åœ¨é‡å¤å…ƒç´ ï¼Œä¸”è¯¥å…ƒç´ ä½œä¸ºå­æ•°ç»„æœ€å°å€¼æ—¶ï¼Œæœ€è¿œå·¦å³ç«¯ç‚¹çš„è¾¹ç•Œè¶Šè¿‡é‡å¤å…ƒç´ æ—¶ï¼Œå¯¼è‡´é‡å¤ç»Ÿè®¡å­æ•°ç»„ã€çš„é—®é¢˜ã€‚**

æˆ‘ä»¬ä¸å¤±ä¸€èˆ¬æ€§çš„ä¸¾ä¸ª ğŸŒ° æ¥ç†è§£ï¼ˆä¸‹å›¾ï¼‰ï¼š

![image.png](https://pic.leetcode.cn/1666924704-fRUbpI-image.png)

ä¸ºäº†æ¶ˆé™¤è¿™ç§é‡å¤ç»Ÿè®¡ï¼Œæˆ‘ä»¬å¯ä»¥å°†ã€Œæœ€è¿œå·¦å³è¾¹ç•Œã€çš„ä¸€ç«¯ï¼Œä»ã€Œä¸¥æ ¼å°äºã€è°ƒæ•´ä¸ºã€Œå°äºç­‰äºã€ï¼Œä»è€Œå®ç°åŠå¼€åŠé—­çš„æ•ˆæœã€‚

ä»£ç ï¼š

* []

```Java
class Solution {
    int MOD = (int)1e9+7;
    public int sumSubarrayMins(int[] arr) {
        int n = arr.length, ans = 0;
        int[] l = new int[n], r = new int[n];
        Arrays.fill(l, -1); Arrays.fill(r, n);
        Deque<Integer> d = new ArrayDeque<>();
        for (int i = 0; i < n; i++) {
            while (!d.isEmpty() && arr[d.peekLast()] >= arr[i]) r[d.pollLast()] = i;
            d.addLast(i);
        }
        d.clear();
        for (int i = n - 1; i >= 0; i--) {
            while (!d.isEmpty() && arr[d.peekLast()] > arr[i]) l[d.pollLast()] = i;
            d.addLast(i);
        }
        for (int i = 0; i < n; i++) {
            int a = i - l[i], b = r[i] - i;
            ans += a * 1L * b % MOD * arr[i] % MOD;
            ans %= MOD;
        }
        return ans;
    }
}
```

* []

```TypeScript
const MOD = 1000000007
function sumSubarrayMins(arr: number[]): number {
    let n = arr.length, ans = 0
    const l = new Array<number>(n).fill(-1), r = new Array<number>(n).fill(n)
    const stk = new Array<number>(n).fill(0)
    let he = 0, ta = 0
    for (let i = 0; i < n; i++) {
        while (he < ta && arr[stk[ta - 1]] >= arr[i]) r[stk[--ta]] = i
        stk[ta++] = i
    }
    he = ta = 0
    for (let i = n - 1; i >= 0; i--) {
        while (he < ta && arr[stk[ta - 1]] > arr[i]) l[stk[--ta]] = i
        stk[ta++] = i
    }
    for (let i = 0; i < n; i++) {
        const a = i - l[i], b = r[i] - i
        ans += a * b % MOD * arr[i] % MOD
        ans %= MOD
    }
    return ans
}
```

* []

```Python
class Solution:
    def sumSubarrayMins(self, arr: List[int]) -> int:
        n, ans = len(arr), 0
        l, r = [-1] * n, [n] * n
        stk = []
        for i in range(n):
            while stk and arr[stk[-1]] >= arr[i]:
                r[stk.pop()] = i
            stk.append(i)
        stk = []
        for i in range(n - 1, -1, -1):
            while stk and arr[stk[-1]] > arr[i]:
                l[stk.pop()] = i
            stk.append(i)
        for i in range(n):
            a, b = i - l[i], r[i] - i
            ans += a * b * arr[i]
        return ans % (10 ** 9 + 7)
```

* æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$
* ç©ºé—´å¤æ‚åº¦ï¼š$O(n)$

---

## ä¼˜åŒ–

å®é™…ä¸Šï¼Œå½“æˆ‘ä»¬ä»æ ˆä¸­å¼¹å‡ºæŸä¸ª $arr[cur]$ æ—¶ï¼Œå…¶å³è¾¹ç•Œå¿…ç„¶æ˜¯å¯¼è‡´å…¶å¼¹å‡ºçš„ `arr[r]`ï¼ˆå½“å‰æ‰€éå†åˆ°çš„å…ƒç´ ï¼‰ï¼Œè€Œ $arr[cur]$ è‹¥å­˜åœ¨å·¦è¾¹ç•Œï¼Œå¿…ç„¶æ˜¯ä½äº $cur$ æ ˆä¸­çš„å‰ä¸€ä½ç½®ï¼Œå³ $arr[cur]$ å¼¹å‡ºåçš„æ–°æ ˆé¡¶å…ƒç´ ï¼ˆè‹¥ä¸å­˜åœ¨ç‰©ç†å·¦è¾¹ç•Œï¼Œåˆ™å·¦è¾¹ç•Œä¸º $-1$ï¼‰ã€‚

ä»£ç ï¼š

* []

```Java
class Solution {
    int MOD = (int)1e9+7;
    public int sumSubarrayMins(int[] arr) {
        int n = arr.length, ans = 0;
        Deque<Integer> d = new ArrayDeque<>();
        for (int r = 0; r <= n; r++) {
            int t = r < n ? arr[r] : 0;
            while (!d.isEmpty() && arr[d.peekLast()] >= t) {
                int cur = d.pollLast();
                int l = d.isEmpty() ? -1 : d.peekLast();
                int a = cur - l, b = r - cur;
                ans += a * 1L * b % MOD * arr[cur] % MOD;
                ans %= MOD;
            }
            d.addLast(r);
        }
        return ans;
    }
}
```

* []

```TypeScript
const MOD = 1000000007
function sumSubarrayMins(arr: number[]): number {
    let n = arr.length, ans = 0
    const stk = new Array<number>(n).fill(0)
    let he = 0, ta = 0
    for (let r = 0; r <= n; r++) {
        const t = r < n ? arr[r] : 0
        while (he < ta && arr[stk[ta - 1]] >= t) {
            const cur = stk[--ta]
            const l = he < ta ? stk[ta - 1] : -1
            const a = cur - l, b = r - cur
            ans += a * b % MOD * arr[cur] % MOD
            ans %= MOD
        }
        stk[ta++] = r
    }
    return ans
}
```

* []

```Python
class Solution:
    def sumSubarrayMins(self, arr: List[int]) -> int:
        n, ans = len(arr), 0
        stk = []
        for r in range(n + 1):
            t = arr[r] if r < n else 0
            while stk and arr[stk[-1]] >= t:
                cur = stk.pop()
                l = stk[-1] if stk else -1
                a, b = cur - l, r - cur
                ans += a * b * arr[cur]
            stk.append(r)
        return ans % (10 ** 9 + 7)
```

* æ—¶é—´å¤æ‚åº¦ï¼š$O(n)$
* ç©ºé—´å¤æ‚åº¦ï¼š$O(n)$

---

## æœ€å

**å¦‚æœæœ‰å¸®åŠ©åˆ°ä½ ï¼Œè¯·ç»™é¢˜è§£ç‚¹ä¸ªèµå’Œæ”¶è—ï¼Œè®©æ›´å¤šçš„äººçœ‹åˆ° ~ ("â–”â–¡â–”)/**

ä¹Ÿæ¬¢è¿ä½  [å…³æ³¨æˆ‘](https://acoier.com/oimg/gzh-qrcode.webp)ï¼Œæä¾›å†™ã€Œè¯æ˜ã€&ã€Œæ€è·¯ã€çš„é«˜è´¨é‡é¢˜è§£ã€‚

æ‰€æœ‰é¢˜è§£å·²ç»åŠ å…¥ [åˆ·é¢˜æŒ‡å—](https://github.com/SharingSource/LogicStack-LeetCode/wiki)ï¼Œæ¬¢è¿ star å“¦ ~
